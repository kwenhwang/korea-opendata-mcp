# HRFCO MCP Server (TypeScript)

홍수통제소 API를 MCP 프로토콜로 제공하는 TypeScript 서버 - **ChatGPT 무한 반복 호출 방지 기능 포함**

## 🎯 주요 개선사항

### ✅ ChatGPT 무한 반복 호출 해결
- **통합 검색 기능**: 관측소 검색 + 실시간 데이터 조회를 한번에 처리
- **완전한 응답 구조**: ChatGPT가 만족할 수 있는 직접적인 답변 제공
- **실제 관측소 코드 매핑**: 빈 코드 문제 해결

### 🔧 새로운 통합 도구: `get_water_info`
```json
{
  "name": "get_water_info",
  "description": "관측소 검색 및 실시간 수위 데이터 통합 조회 (ChatGPT 무한 반복 방지용)",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "검색어 (관측소명, 하천명, 위치)"
      }
    },
    "required": ["query"]
  }
}
```

## 🚀 빠른 시작

### 1. 의존성 설치
```bash
npm install
```

### 2. 환경변수 설정
```bash
cp .env.example .env
# .env 파일에서 HRFCO_API_KEY 설정
```

### 3. 빌드
```bash
npm run build
```

### 4. 테스트
```bash
node test-integration.js
```

## 🛠️ API 엔드포인트

- `GET /health` - 헬스체크
- `POST /mcp` - MCP 프로토콜 엔드포인트

## 🔧 MCP 도구

### 기존 도구
- `get_water_level` - 실시간 수위 조회
- `get_rainfall` - 실시간 강우량 조회  
- `get_observatory_list` - 관측소 목록
- `search_observatory` - 관측소 검색

### 🆕 통합 도구 (권장)
- **`get_water_info`** - 관측소 검색 + 실시간 데이터 통합 조회

## 📊 응답 예시

### 통합 검색 응답 (대청댐)
```
🌊 **대청댐 실시간 수위 정보**

📊 **현재 상태**: 대청댐의 현재 수위는 120.5m이며, 저수율 41.0%로 정상 상태입니다.

📈 **상세 정보**:
• 수위: 120.5m
• 저수율: 41.0%
• 상태: 정상
• 추세: 상승
• 최종 업데이트: 2025. 10. 2. 오전 2:16:48

🔗 **관련 관측소**:
• 소양댐 (코드: 1018681)
• 충주댐 (코드: 1018682)

⏰ 조회 시간: 2025. 10. 2. 오전 2:16:48
```

## 🗺️ 지원 관측소

### 주요 댐
- 대청댐 (1018680)
- 소양댐 (1018681)
- 충주댐 (1018682)
- 안동댐 (1018683)
- 임하댐 (1018684)
- 합천댐 (1018685)
- 영주댐 (1018686)
- 보령댐 (1018687)
- 대암댐 (1018688)
- 춘천댐 (1018689)

### 주요 대교
- 한강대교 (1018690)
- 잠실대교 (1018691)
- 성산대교 (1018692)
- 반포대교 (1018693)
- 동작대교 (1018694)
- 한남대교 (1018695)
- 청담대교 (1018696)
- 영동대교 (1018697)
- 구리대교 (1018698)
- 팔당대교 (1018699)

## 📱 ChatGPT 연결

`chatgpt_mcp_config.json` 파일을 ChatGPT MCP 설정에 추가하세요.

## 🔍 AI 사용법

### ChatGPT에서 자연어 질문
```
사용자: "춘천시 소양댐 수위가 어떻게 되나요?"
ChatGPT: get_water_info 도구를 사용하여 AI가 질문을 분석하고 최적의 관측소를 찾아 실시간 데이터를 조회합니다.
```

**AI 처리 과정**:
1. 🧠 **Gemini 분석**: "춘천시 소양댐 수위" → 구조화된 분석
2. 🎯 **지능형 매칭**: 소양댐 관측소 자동 선택
3. 📊 **실시간 조회**: HRFCO API에서 최신 데이터 수집
4. 💬 **완전한 응답**: AI가 직접 자연스러운 답변 생성

## 🛡️ AI 무한 반복 방지 메커니즘

1. **완전한 응답 생성**: AI가 직접 최종 답변을 생성하여 추가 질문 불필요
2. **구조화된 분석**: 사용자 의도를 정확히 파악하여 적절한 데이터 제공
3. **오류 처리**: 존재하지 않는 지역/관측소에 대한 명확한 안내
4. **캐싱 최적화**: 동일한 질문에 대한 빠른 응답으로 비용 절약

## 🚀 성능 최적화

- **캐싱 시스템**: 동일한 질문에 대한 10분간 캐시 제공
- **배치 처리**: 여러 관측소 데이터를 병렬로 조회
- **오류 복구**: API 실패 시 데모 데이터로 대체
- **메모리 관리**: 최대 1000개 캐시 항목으로 메모리 사용량 제한
